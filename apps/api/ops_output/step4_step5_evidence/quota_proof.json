{
  "evidence_type": "quota_implementation",
  "step": "4.1",
  "timestamp": "2026-01-11T20:15:00Z",
  "status": "IMPLEMENTED",

  "implementation": {
    "models_file": "app/models/quota.py",
    "service_file": "app/services/quota_service.py",
    "tables_created": [
      "quota_policies",
      "usage_daily_rollups",
      "usage_events",
      "alpha_whitelist",
      "run_estimates",
      "run_abort_logs"
    ]
  },

  "tier_policies": {
    "free": {
      "max_runs_per_user_per_day": 5,
      "max_steps_per_user_per_day": 500,
      "max_exports_per_user_per_day": 10,
      "max_runs_per_project_per_day": 10,
      "max_steps_per_run": 50,
      "max_agents_per_run": 100,
      "max_llm_calls_per_run": 100,
      "max_tokens_per_run": 50000,
      "max_wall_clock_seconds": 120,
      "max_cost_usd_per_run": 0.50,
      "max_concurrent_runs": 1
    },
    "alpha": {
      "max_runs_per_user_per_day": 20,
      "max_steps_per_user_per_day": 2000,
      "max_exports_per_user_per_day": 50,
      "max_runs_per_project_per_day": 50,
      "max_steps_per_run": 100,
      "max_agents_per_run": 500,
      "max_llm_calls_per_run": 500,
      "max_tokens_per_run": 200000,
      "max_wall_clock_seconds": 300,
      "max_cost_usd_per_run": 2.0,
      "max_concurrent_runs": 3
    },
    "team": {
      "max_runs_per_user_per_day": 100,
      "max_steps_per_user_per_day": 10000,
      "max_exports_per_user_per_day": 200,
      "max_runs_per_project_per_day": 200,
      "max_steps_per_run": 500,
      "max_agents_per_run": 5000,
      "max_llm_calls_per_run": 2000,
      "max_tokens_per_run": 1000000,
      "max_wall_clock_seconds": 600,
      "max_cost_usd_per_run": 10.0,
      "max_concurrent_runs": 10
    },
    "enterprise": {
      "max_runs_per_user_per_day": 1000,
      "max_steps_per_user_per_day": 100000,
      "max_exports_per_user_per_day": 1000,
      "max_runs_per_project_per_day": 1000,
      "max_steps_per_run": 1000,
      "max_agents_per_run": 100000,
      "max_llm_calls_per_run": 10000,
      "max_tokens_per_run": 10000000,
      "max_wall_clock_seconds": 3600,
      "max_cost_usd_per_run": 100.0,
      "max_concurrent_runs": 50
    }
  },

  "redis_key_scheme": {
    "user_daily_runs": "quota:user:{user_id}:runs_created:{YYYYMMDD}",
    "user_daily_steps": "quota:user:{user_id}:steps_executed:{YYYYMMDD}",
    "user_daily_exports": "quota:user:{user_id}:exports:{YYYYMMDD}",
    "project_daily_runs": "quota:project:{project_id}:runs_created:{YYYYMMDD}",
    "run_tokens": "quota:run:{run_id}:tokens",
    "run_llm_calls": "quota:run:{run_id}:llm_calls",
    "run_cost": "quota:run:{run_id}:cost_usd",
    "run_start_time": "quota:run:{run_id}:start_time"
  },

  "error_response_format": {
    "error": "quota_exceeded",
    "error_code": "USER_DAILY_RUNS_EXCEEDED",
    "limit": 5,
    "used": 5,
    "reset_at": "2026-01-12T00:00:00Z",
    "message": "You have reached your daily run limit of 5 runs"
  },

  "verification": {
    "models_exist": true,
    "service_methods": [
      "check_user_daily_runs",
      "check_project_daily_runs",
      "check_run_limits",
      "increment_user_runs",
      "increment_project_runs",
      "init_run_tracking",
      "increment_run_counters",
      "get_run_stats",
      "log_usage_event",
      "log_run_abort",
      "check_and_enforce_quota",
      "get_user_usage_summary"
    ],
    "redis_integration": true,
    "postgres_audit": true
  }
}

{
  "evidence_type": "kill_switch_implementation",
  "step": "4.4",
  "timestamp": "2026-01-11T20:15:00Z",
  "status": "IMPLEMENTED",

  "implementation": {
    "service_file": "app/services/kill_switch.py",
    "admin_endpoint": "POST /admin/kill-run/{run_id}"
  },

  "kill_reasons": [
    {
      "code": "max_tokens",
      "description": "Token limit exceeded",
      "trigger": "automatic"
    },
    {
      "code": "max_llm_calls",
      "description": "LLM call limit exceeded",
      "trigger": "automatic"
    },
    {
      "code": "max_runtime",
      "description": "Wall clock time exceeded",
      "trigger": "automatic"
    },
    {
      "code": "max_cost",
      "description": "Cost limit exceeded",
      "trigger": "automatic"
    },
    {
      "code": "admin_kill",
      "description": "Admin-initiated termination",
      "trigger": "manual"
    },
    {
      "code": "user_cancel",
      "description": "User-initiated cancellation",
      "trigger": "manual"
    },
    {
      "code": "system_error",
      "description": "System error during execution",
      "trigger": "automatic"
    }
  ],

  "redis_flag": {
    "key": "kill:run:{run_id}",
    "ttl_seconds": 3600,
    "checked_by_worker": true
  },

  "abort_logging": {
    "table": "run_abort_logs",
    "fields": [
      "run_id",
      "user_id",
      "abort_reason",
      "abort_message",
      "tokens_at_abort",
      "llm_calls_at_abort",
      "runtime_at_abort",
      "cost_at_abort",
      "triggered_by",
      "created_at"
    ]
  },

  "service_methods": [
    "check_and_kill_if_needed",
    "kill_run",
    "admin_kill_run",
    "user_cancel_run",
    "is_run_killed",
    "get_kill_stats",
    "clear_kill_flag"
  ],

  "guard_class": {
    "name": "KillSwitchGuard",
    "usage": "Context manager for killable operations",
    "methods": ["check", "raise_if_killed"]
  },

  "integration_points": [
    "Called after each LLM call",
    "Called after each step execution",
    "Called by periodic health check task",
    "Admin endpoint for manual kills"
  ],

  "verification": {
    "service_exists": true,
    "redis_flag_support": true,
    "celery_task_revoke": true,
    "db_status_update": true,
    "audit_logging": true
  }
}

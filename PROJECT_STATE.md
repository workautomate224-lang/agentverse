# PROJECT_STATE.md

> **Last Updated:** 2026-01-20
> **Generated By:** Claude Opus 4.5 from codebase analysis
> **Status:** Production-ready documentation for architectural review

---

## 0. Executive Summary

**AgentVerse** is an AI-powered consumer simulation platform that predicts human decisions at scale. The platform enables organizations to run "what-if" simulations using synthetic personas grounded in real census data, producing auditable predictions with confidence intervals.

### Core Value Proposition
- **Predictive Simulations**: Simulate consumer behavior before real-world deployment
- **Temporal Knowledge Isolation**: Prevent data leakage in backtesting scenarios
- **Blueprint-Driven Orchestration**: AI-assisted project configuration via PIL (Project Intelligence Layer)
- **Multi-tenant SaaS**: Enterprise-ready with tenant isolation, audit logging, and cost controls

### Architecture Pattern
```
Frontend (Next.js 14) → FastAPI → PostgreSQL + Redis → Celery Workers → OpenRouter LLM
                    ↓
              WebSocket (real-time simulation updates)
```

### Current Deployment State
- **Staging**: Fully deployed on Railway (6 services)
- **Production**: Ready for deployment (same architecture)
- **Local Dev**: Docker Compose with hot-reload

---

## 1. Repo Map

```
agentverse/                          # Root - Turborepo monorepo (npm workspaces)
├── package.json                     # Root package.json - Turborepo scripts
├── turbo.json                       # Turborepo configuration
├── docker-compose.yml               # Local development infrastructure
│
├── apps/
│   ├── web/                         # Next.js 14 frontend
│   │   ├── src/
│   │   │   ├── app/                 # App Router pages (88 page.tsx files)
│   │   │   │   ├── auth/            # Login, register, forgot-password
│   │   │   │   ├── dashboard/       # Main dashboard routes
│   │   │   │   │   ├── projects/    # Project management
│   │   │   │   │   ├── personas/    # Persona management
│   │   │   │   │   ├── runs/        # Simulation run management
│   │   │   │   │   ├── products/    # Product testing
│   │   │   │   │   ├── marketplace/ # Template marketplace
│   │   │   │   │   └── ...          # Additional dashboard routes
│   │   │   │   ├── p/[projectId]/   # Project-specific routes
│   │   │   │   │   ├── event-lab/   # Event Lab (scenario generation)
│   │   │   │   │   ├── run-center/  # Run orchestration
│   │   │   │   │   ├── universe-map/# Universe Map visualization
│   │   │   │   │   └── ...          # Additional project routes
│   │   │   │   └── api/             # Next.js API routes (NextAuth, OpenRouter proxy)
│   │   │   ├── components/          # React components
│   │   │   │   ├── pil/             # PIL (Project Intelligence Layer) components
│   │   │   │   ├── ui/              # Radix-based UI primitives
│   │   │   │   └── ...              # Feature-specific components
│   │   │   ├── hooks/               # React hooks (useApi.ts, useWebSocket.ts)
│   │   │   ├── lib/                 # Utilities (api.ts, auth.ts)
│   │   │   └── types/               # TypeScript types
│   │   ├── package.json             # Frontend dependencies
│   │   └── next.config.js           # Next.js configuration
│   │
│   └── api/                         # FastAPI backend
│       ├── app/
│       │   ├── main.py              # Application entry point
│       │   ├── api/v1/              # REST API endpoints (40+ modules)
│       │   │   ├── router.py        # Central router
│       │   │   └── endpoints/       # Endpoint modules
│       │   ├── core/                # Core utilities (config, security, websocket)
│       │   ├── db/                  # Database session and base
│       │   ├── engine/              # Simulation engine
│       │   ├── models/              # SQLAlchemy models (35 files, 100+ models)
│       │   ├── schemas/             # Pydantic schemas
│       │   ├── services/            # Business logic services
│       │   │   ├── llm_router.py    # Centralized LLM gateway
│       │   │   ├── leakage_guard.py # Temporal Knowledge Isolation
│       │   │   ├── data_gateway.py  # Centralized data access
│       │   │   └── ...              # Additional services
│       │   ├── tasks/               # Celery tasks (8 files)
│       │   └── middleware/          # Custom middleware
│       ├── alembic/                 # Database migrations (45 versions)
│       ├── requirements.txt         # Python dependencies
│       └── Dockerfile               # Backend container
│
├── packages/
│   ├── contracts/                   # Shared TypeScript types
│   └── ui/                          # Shared UI components
│
├── infrastructure/
│   └── docker/
│       └── init.sql                 # Initial database setup
│
└── docs/
    ├── project.md                   # Technical specification
    ├── blueprint.md                 # Blueprint orchestration spec
    ├── temporal.md                  # Temporal Knowledge Isolation spec
    └── techstack.md                 # Technology reference
```

### Key File Inventory

| Purpose | Location | Lines |
|---------|----------|-------|
| API Entry | `apps/api/app/main.py` | ~218 |
| API Router | `apps/api/app/api/v1/router.py` | ~156 |
| Settings | `apps/api/app/core/config.py` | ~129 |
| LLM Gateway | `apps/api/app/services/llm_router.py` | ~994 |
| Leakage Guard | `apps/api/app/services/leakage_guard.py` | ~350 |
| Data Gateway | `apps/api/app/services/data_gateway.py` | ~450 |
| Auth (Frontend) | `apps/web/src/lib/auth.ts` | ~200 |
| API Client | `apps/web/src/lib/api.ts` | ~2000+ |
| React Hooks | `apps/web/src/hooks/useApi.ts` | ~500+ |

---

## 2. Infrastructure & Deployment

### 2.1 Railway Services (Staging)

| Service Name | Type | Railway URL | Notes |
|--------------|------|-------------|-------|
| `agentverse-web-staging` | Next.js | `https://agentverse-web-staging-production.up.railway.app` | Frontend |
| `agentverse-api-staging` | FastAPI | `https://agentverse-api-staging-production.up.railway.app` | Backend API |
| `agentverse-worker-staging` | Celery | Internal | Background tasks |
| `postgres-staging` | PostgreSQL 16 | Internal | Database |
| `redis-staging` | Redis 7 | Internal | Cache + Celery broker |
| `minio-staging` | MinIO | Internal | S3-compatible storage |

### 2.2 Build Commands

**Frontend (Next.js)**
```bash
# Build
npm install && npm run build

# Start
npm run start

# Dev
npm run dev  # Port 3002
```

**Backend (FastAPI)**
```bash
# Start API
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# Celery Worker
celery -A app.worker worker --loglevel=info

# Celery Beat (Scheduler)
celery -A app.worker beat --loglevel=info

# Migrations
alembic upgrade head
```

### 2.3 Docker Compose (Local Development)

```yaml
# Services defined in docker-compose.yml
services:
  postgres:    # Port 5433:5432
  redis:       # Port 6379:6379
  api:         # Port 8000:8000
  web:         # Port 3000:3000
  celery-worker:
  celery-beat:
```

**Startup:**
```bash
# From repo root
docker-compose up -d
```

### 2.4 Railway Environment Variables

**Required for API service:**
```env
DATABASE_URL=postgresql+asyncpg://...
REDIS_URL=redis://...
OPENROUTER_API_KEY=sk-or-v1-...
SECRET_KEY=<production-secret>
ENVIRONMENT=staging
```

**Required for Web service:**
```env
BACKEND_API_URL=https://agentverse-api-staging-production.up.railway.app
NEXTAUTH_URL=https://agentverse-web-staging-production.up.railway.app
NEXTAUTH_SECRET=<production-secret>
OPENROUTER_API_KEY=sk-or-v1-...
```

---

## 3. Service Communication Topology

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              USER BROWSER                                    │
└─────────────────────────┬────────────────────────────────────────┬──────────┘
                          │ HTTP/HTTPS                             │ WebSocket
                          ▼                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         NEXT.JS 14 (apps/web)                                │
│  ┌───────────────┐  ┌───────────────┐  ┌──────────────────────────────────┐ │
│  │ App Router    │  │ NextAuth.js   │  │ React Query + Zustand            │ │
│  │ (SSR + CSR)   │  │ (JWT Auth)    │  │ (Data Fetching + State)          │ │
│  └───────┬───────┘  └───────────────┘  └──────────────────────────────────┘ │
│          │                                                                   │
│  ┌───────▼───────────────────────────────────────────────────────────────┐  │
│  │ API Routes (/api/*)                                                    │  │
│  │ - /api/auth/*      (NextAuth endpoints)                               │  │
│  │ - /api/ask/*       (OpenRouter proxy for Event Lab)                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────┬────────────────────────────────────────────────────┘
                          │ HTTP (BACKEND_API_URL)
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         FASTAPI (apps/api)                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ Middleware Stack:                                                      │  │
│  │   CORSMiddleware → PrometheusMetricsMiddleware → TenantMiddleware     │  │
│  │   → RateLimitMiddleware                                                │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ API v1 Router (/api/v1/*)                                               ││
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ ││
│  │ │ /auth       │ │ /projects   │ │ /runs       │ │ /blueprints         │ ││
│  │ │ /users      │ │ /scenarios  │ │ /nodes      │ │ /pil-jobs           │ ││
│  │ │ /personas   │ │ /simulations│ │ /telemetry  │ │ /ask                │ ││
│  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘ ││
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ ││
│  │ │ /calibration│ │ /reliability│ │ /backtests  │ │ /governance         │ ││
│  │ │ /reports    │ │ /exports    │ │ /privacy    │ │ /admin/llm          │ ││
│  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘ ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Core Services                                                            ││
│  │ ┌─────────────────┐ ┌─────────────────┐ ┌────────────────────────────┐  ││
│  │ │ LLMRouter       │ │ LeakageGuard    │ │ DataGateway               │  ││
│  │ │ (OpenRouter)    │ │ (Temporal Iso.) │ │ (External Data Access)    │  ││
│  │ └────────┬────────┘ └────────┬────────┘ └────────────────────────────┘  ││
│  │          │                   │                                           ││
│  │          └───────────────────┼─────────────────────┐                    ││
│  └──────────────────────────────┼─────────────────────┼────────────────────┘│
│                                 │                     │                      │
│  ┌──────────────────────────────▼─────────────────────▼────────────────────┐│
│  │ WebSocket Manager (Real-time simulation updates)                         ││
│  └──────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────┬────────────────┬────────────────┬─────────────────┘
                          │ asyncpg        │ aioredis       │ Celery
                          ▼                ▼                ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────────────┐
│ PostgreSQL 16    │  │ Redis 7          │  │ Celery Workers                   │
│ - 100+ tables    │  │ - Cache          │  │ - run_executor.py                │
│ - 45 migrations  │  │ - Rate limiting  │  │ - pil_tasks.py                   │
│ - Multi-tenant   │  │ - Celery broker  │  │ - calibration.py                 │
└──────────────────┘  │ - WebSocket pub  │  │ - world_simulation.py            │
                      └──────────────────┘  │ - chaos_tasks.py                 │
                                            └──────────────────────────────────┘
                          │
                          ▼ HTTP
┌──────────────────────────────────────────────────────────────────────────────┐
│                         OPENROUTER API                                        │
│  Endpoint: https://openrouter.ai/api/v1/chat/completions                     │
│  Default Model: openai/gpt-5.2 (configurable)                                │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. End-to-End Flows

### 4.1 Authentication Flow

```
┌─────────────┐     POST /api/auth/callback/credentials     ┌─────────────────┐
│ Login Form  │ ────────────────────────────────────────▶   │ NextAuth.js     │
│ (page.tsx)  │                                             │ (auth.ts)       │
└─────────────┘                                             └────────┬────────┘
                                                                     │
                           POST /api/v1/auth/login                   │
┌─────────────────┐   {email, password}                              │
│ FastAPI Backend │ ◀────────────────────────────────────────────────┘
│ (auth.py)       │
└────────┬────────┘
         │
         │  1. Validate credentials against User table
         │  2. Generate JWT access_token + refresh_token
         │  3. Return user data + tokens
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ JWT Token Payload:                                                           │
│ {                                                                            │
│   "sub": user_id,                                                           │
│   "tenant_id": tenant_id,                                                   │
│   "role": "admin|user",                                                     │
│   "tier": "free|pro|enterprise",                                            │
│   "exp": <24 hours from now>                                                │
│ }                                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         │  Token stored in NextAuth session (server-side)
         ▼
┌─────────────────┐
│ Session Cookie  │  HTTP-only cookie with encrypted session
│ (browser)       │  Contains: id, accessToken, role, tier
└─────────────────┘
```

**Source Files:**
- Frontend: `apps/web/src/lib/auth.ts:1-200`
- Backend: `apps/api/app/api/v1/endpoints/auth.py`
- Security: `apps/api/app/core/security.py`

### 4.2 Simulation Run Flow

```
User clicks "Start Run" in Run Center UI
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ POST /api/v1/runs                                                            │
│ Body: { project_id, scenario_id, run_config, fork_from_node_id }            │
└────────────────────────────────────────────┬────────────────────────────────┘
                                             │
                                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ RunsEndpoint.create_run()                                                    │
│ 1. Validate tenant ownership                                                 │
│ 2. Create Run record (status=PENDING)                                       │
│ 3. Create RunManifest (reproducibility)                                     │
│ 4. Fork source Node if fork_from_node_id specified (C1: Fork-not-mutate)   │
│ 5. Queue Celery task: run_executor.execute_run.delay(run_id)               │
└────────────────────────────────────────────┬────────────────────────────────┘
                                             │
                                             ▼ Celery Queue
┌─────────────────────────────────────────────────────────────────────────────┐
│ run_executor.execute_run(run_id)                                             │
│                                                                              │
│ 1. Load Run, Project, Scenario, RunConfig                                   │
│ 2. Initialize LeakageGuard with cutoff_time                                 │
│ 3. Load personas via DataGateway (temporal isolation enforced)              │
│ 4. For each simulation tick:                                                │
│    a. Apply event scripts (if triggered)                                    │
│    b. Execute agent decisions (rules-based, no LLM in loop - C5)           │
│    c. Record telemetry to S3 (JSONL format)                                 │
│    d. Emit WebSocket progress update                                        │
│ 5. Create new Node with simulation results (C1: immutable)                  │
│ 6. Generate OutcomeReport with probability distributions                    │
│ 7. Update Run status = COMPLETED                                            │
└────────────────────────────────────────────┬────────────────────────────────┘
                                             │
                                             ▼ WebSocket
┌─────────────────────────────────────────────────────────────────────────────┐
│ Real-time updates to UI:                                                     │
│ - Progress percentage                                                        │
│ - Current tick number                                                        │
│ - Agent count processed                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Source Files:**
- Endpoint: `apps/api/app/api/v1/endpoints/runs.py`
- Executor: `apps/api/app/tasks/run_executor.py`
- LeakageGuard: `apps/api/app/services/leakage_guard.py`
- DataGateway: `apps/api/app/services/data_gateway.py`

### 4.3 Blueprint + PIL Job Flow

```
User creates new Project → Enters goal in Blueprint wizard
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ POST /api/v1/blueprints                                                      │
│ Body: { project_id, goal: "Predict consumer adoption of new EV model" }     │
└────────────────────────────────────────────┬────────────────────────────────┘
                                             │
                                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ BlueprintService.create_blueprint()                                          │
│ 1. Create Blueprint record                                                   │
│ 2. Create PILJob (type=GOAL_ANALYSIS, status=PENDING)                       │
│ 3. Queue Celery task: pil_tasks.execute_pil_job.delay(pil_job_id)          │
└────────────────────────────────────────────┬────────────────────────────────┘
                                             │
                                             ▼ Celery Queue
┌─────────────────────────────────────────────────────────────────────────────┐
│ pil_tasks.execute_pil_job(pil_job_id)                                        │
│                                                                              │
│ 1. Load PILJob and Blueprint                                                │
│ 2. Build LLM prompt from goal + context                                     │
│ 3. Call LLMRouter.complete() with profile="pil_goal_analysis"              │
│    └── LLMRouter calls OpenRouter API                                       │
│ 4. Parse structured response:                                               │
│    - domain_guess: "automotive_ev"                                          │
│    - target_output: "adoption_rate"                                         │
│    - primary_driver: "price_sensitivity"                                    │
│    - recommended_slots: [...]                                               │
│ 5. Create PILArtifact with results                                          │
│ 6. Update BlueprintSlots based on recommendations                           │
│ 7. Update PILJob status = COMPLETED                                         │
└────────────────────────────────────────────┬────────────────────────────────┘
                                             │
                                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Frontend receives Blueprint with:                                            │
│ - Pre-filled slots (personas, rules, scenarios)                             │
│ - Confidence scores per slot                                                │
│ - Next recommended actions                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Source Files:**
- Blueprint Endpoint: `apps/api/app/api/v1/endpoints/blueprints.py`
- PIL Job Endpoint: `apps/api/app/api/v1/endpoints/pil_jobs.py`
- PIL Tasks: `apps/api/app/tasks/pil_tasks.py`
- LLM Router: `apps/api/app/services/llm_router.py`

### 4.4 Event Lab (Ask Endpoint) Flow

```
User types: "What if gas prices increase 50%?" in Event Lab
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ POST /api/ask/generate (Next.js API Route)                                   │
│ Body: { question: "...", project_id }                                       │
└────────────────────────────────────────────┬────────────────────────────────┘
                                             │
                                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Next.js API Route (/api/ask/generate/route.ts)                               │
│ 1. Validate session (must be authenticated)                                  │
│ 2. Build prompt with project context                                        │
│ 3. Call OpenRouter API directly:                                            │
│    POST https://openrouter.ai/api/v1/chat/completions                       │
│    Headers: Authorization: Bearer ${OPENROUTER_API_KEY}                     │
│    Body: { model: "openai/gpt-4o-mini", messages: [...] }                   │
│ 4. Parse structured response into EventScript format                        │
└────────────────────────────────────────────┬────────────────────────────────┘
                                             │
                                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Response: EventScript suggestion                                             │
│ {                                                                            │
│   name: "Gas Price Shock",                                                  │
│   type: "economic_shock",                                                   │
│   trigger_condition: { tick: 5 },                                           │
│   delta_operations: [                                                       │
│     { target: "fuel_price", operation: "multiply", value: 1.5 }            │
│   ]                                                                          │
│ }                                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Source Files:**
- Next.js Route: `apps/web/src/app/api/ask/generate/route.ts`
- Backend Endpoint: `apps/api/app/api/v1/endpoints/ask.py`
- Event Script Models: `apps/api/app/models/event_script.py`

---

## 5. Environment & Configuration

### 5.1 Backend Environment Variables

| Variable | Required | Default | Description | Source |
|----------|----------|---------|-------------|--------|
| `DATABASE_URL` | Yes | `postgresql+asyncpg://...` | PostgreSQL connection | Railway |
| `REDIS_URL` | Yes | `redis://localhost:6379/0` | Redis connection | Railway |
| `SECRET_KEY` | Yes | Dev placeholder | JWT signing key | Railway |
| `OPENROUTER_API_KEY` | Yes (staging/prod) | Empty | OpenRouter API key | Railway |
| `OPENROUTER_BASE_URL` | No | `https://openrouter.ai/api/v1` | OpenRouter endpoint | `config.py:66` |
| `DEFAULT_MODEL` | No | `openai/gpt-5.2` | Default LLM model | `config.py:67` |
| `ENVIRONMENT` | No | `development` | Environment name | `config.py:24` |
| `DEBUG` | No | `true` | Debug mode | `config.py:25` |
| `PIL_ALLOW_FALLBACK` | No | `false` | Allow mock LLM fallback | `config.py:72` |
| `SENTRY_DSN` | No | None | Sentry error tracking | `config.py:75` |
| `CENSUS_API_KEY` | No | None | US Census API key | `config.py:78` |
| `USE_REAL_CENSUS_DATA` | No | `true` | Use real census data | `config.py:80` |
| `CORS_ORIGINS` | No | Localhost list | Allowed CORS origins | `config.py:43-50` |
| `STORAGE_BACKEND` | No | `s3` | Storage backend type | `config.py:95` |
| `STORAGE_BUCKET` | No | `agentverse-artifacts` | S3 bucket name | `config.py:96` |
| `STAGING_OPS_API_KEY` | No | Empty | Chaos testing auth | `config.py:119` |

**Source:** `apps/api/app/core/config.py`

### 5.2 Frontend Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `NEXT_PUBLIC_API_URL` | No | Empty | Public API URL (client-side) |
| `BACKEND_API_URL` | Yes | `http://localhost:8000` | Backend URL (server-side) |
| `NEXTAUTH_URL` | Yes | `http://localhost:3002` | NextAuth callback URL |
| `NEXTAUTH_SECRET` | Yes | Dev secret | NextAuth encryption key |
| `OPENROUTER_API_KEY` | Yes | Empty | OpenRouter API key |

**Source:** `apps/web/CLAUDE.md`, `apps/web/src/lib/auth.ts`

### 5.3 Settings Loaded At

```python
# Backend: Settings loaded at import time via @lru_cache
# apps/api/app/core/config.py:122-128
@lru_cache
def get_settings() -> Settings:
    return Settings()

settings = get_settings()  # Module-level singleton
```

```typescript
// Frontend: Environment read at runtime
// apps/web/src/lib/auth.ts:12
const API_URL = process.env.BACKEND_API_URL || process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
```

---

## 6. Security & Auth

### 6.1 Authentication Architecture

**Frontend (NextAuth.js):**
- Strategy: JWT (stateless)
- Session Duration: 24 hours
- Storage: HTTP-only encrypted cookie
- Provider: Custom credentials provider

**Backend (FastAPI):**
- Token Type: JWT (HS256)
- Access Token Expiry: 24 hours (`config.py:32`)
- Refresh Token Expiry: 7 days (`config.py:33`)
- Token Location: `Authorization: Bearer <token>` header

### 6.2 Authorization Model

```python
# Role-based access (from User model)
class User:
    role: str  # "admin" | "user"
    tier: str  # "free" | "pro" | "enterprise"
    tenant_id: UUID  # Multi-tenancy
```

**Permission Matrix:**

| Action | admin | user | Tier Limits |
|--------|-------|------|-------------|
| Create Project | ✅ | ✅ | Max projects by tier |
| Run Simulation | ✅ | ✅ | Max agents by tier |
| View All Tenant Data | ✅ | ❌ | - |
| LLM Admin Panel | ✅ | ❌ | - |
| Chaos Testing | ✅ | ❌ | Staging only |

### 6.3 Multi-Tenancy Enforcement

```python
# TenantMiddleware (apps/api/app/middleware/tenant.py)
# Extracts tenant_id from JWT and injects into request state

# All database queries MUST include tenant filter:
async def get_projects(db: AsyncSession, tenant_id: UUID):
    return await db.execute(
        select(Project).where(Project.tenant_id == tenant_id)
    )
```

### 6.4 Security Headers (Frontend)

```javascript
// next.config.js security headers
{
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
  'Referrer-Policy': 'strict-origin-when-cross-origin',
  'Permissions-Policy': 'camera=(), microphone=(), geolocation=()'
}
```

### 6.5 Rate Limiting

```python
# apps/api/app/middleware/rate_limit.py
# Limits from config.py:83-84
RATE_LIMIT_PER_MINUTE: int = 60
RATE_LIMIT_PER_HOUR: int = 1000
```

---

## 7. Database Schema

### 7.1 Core Entity Relationships

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              TENANT ISOLATION                                 │
│  ┌─────────────┐                                                             │
│  │   Tenant    │◀──────────────────────────────────────────────────────┐    │
│  │  (tenant_id)│                                                        │    │
│  └──────┬──────┘                                                        │    │
│         │                                                               │    │
│         │ 1:N                                                           │    │
│         ▼                                                               │    │
│  ┌─────────────┐    1:N    ┌─────────────┐    1:N    ┌─────────────┐   │    │
│  │    User     │──────────▶│   Project   │──────────▶│  Scenario   │   │    │
│  │             │           │             │           │             │   │    │
│  └─────────────┘           └──────┬──────┘           └─────────────┘   │    │
│                                   │                                     │    │
│                                   │ 1:N                                 │    │
│                                   ▼                                     │    │
│                            ┌─────────────┐    1:N    ┌─────────────┐   │    │
│                            │    Run      │──────────▶│    Node     │   │    │
│                            │             │           │ (immutable) │   │    │
│                            └──────┬──────┘           └──────┬──────┘   │    │
│                                   │                         │          │    │
│                                   │ 1:1                     │ 1:N      │    │
│                                   ▼                         ▼          │    │
│                            ┌─────────────┐           ┌─────────────┐   │    │
│                            │ RunManifest │           │    Edge     │   │    │
│                            │(reproducib.)│           │ (parent→   │   │    │
│                            └─────────────┘           │  child)    │   │    │
│                                                      └─────────────┘   │    │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Model Count by Domain

| Domain | Model Count | Key Models |
|--------|-------------|------------|
| Core Simulation | 15 | Project, Scenario, Run, Node, Edge, RunConfig |
| Personas | 8 | Persona, PersonaTemplate, PersonaRecord, PersonaSnapshot |
| Events | 6 | EventScript, EventBundle, EventCandidate, EventValidation |
| LLM | 5 | LLMProfile, LLMCall, LLMCache |
| Blueprint/PIL | 8 | Blueprint, BlueprintSlot, PILJob, PILArtifact |
| Reliability | 6 | CalibrationResult, StabilityTest, DriftReport |
| Production | 12 | QuotaConfig, CostRecord, SafetyRule, FeatureFlag |
| Temporal | 2 | SourceCapability, SourceCapabilityAudit |
| **Total** | **100+** | See `apps/api/app/models/__init__.py` |

### 7.3 Migration History

```
Total Migrations: 45 (as of 2026-01-19)

Key Migrations:
├── 2024_01_01_0001 - Initial schema (User, Project, Scenario)
├── 2026_01_08_0001 - Predictive simulation tables
├── 2026_01_08_0002 - Spec-compliant schema (Node, Run)
├── 2026_01_09_0001 - LLM router tables
├── 2026_01_10_0001 - Run execution audit
├── 2026_01_14_0002 - Temporal isolation (SourceCapability)
├── 2026_01_15_0001 - Blueprint tables
└── 2026_01_19_0001 - LLM proof to guidance
```

**Source:** `apps/api/alembic/versions/`

### 7.4 Key Indexes

```sql
-- Multi-tenant queries (all tables with tenant_id)
CREATE INDEX ix_{table}_tenant_id ON {table}(tenant_id);

-- Run queries
CREATE INDEX ix_runs_project_id ON runs(project_id);
CREATE INDEX ix_runs_status ON runs(status);

-- Node tree traversal
CREATE INDEX ix_edges_parent_id ON edges(parent_node_id);
CREATE INDEX ix_edges_child_id ON edges(child_node_id);

-- Telemetry queries
CREATE INDEX ix_telemetry_index_run_id ON telemetry_index(run_id);
```

---

## 8. AI / LLM Integration

### 8.1 LLM Router Architecture

```python
# apps/api/app/services/llm_router.py

class LLMRouter:
    """
    Centralized LLM gateway with:
    - Profile-based model selection
    - Caching (Redis-backed)
    - Cost tracking
    - Backtest policy injection
    - Fallback handling
    """

    async def complete(
        self,
        profile: LLMProfileKey,  # "pil_goal_analysis", "event_compilation", etc.
        messages: List[Message],
        context: Optional[Dict] = None,
    ) -> LLMResponse:
        # 1. Load profile config (model, temperature, max_tokens)
        # 2. Check cache for identical request
        # 3. Apply backtest policy if cutoff_time present
        # 4. Call OpenRouter API
        # 5. Log LLMCall for audit
        # 6. Cache response
        # 7. Return parsed result
```

### 8.2 LLM Profiles

| Profile Key | Model | Use Case |
|-------------|-------|----------|
| `pil_goal_analysis` | gpt-5.2 | Blueprint goal parsing |
| `pil_slot_filling` | gpt-5.2 | Auto-populate blueprint slots |
| `event_compilation` | gpt-4o-mini | Event Lab scenario generation |
| `alignment_scoring` | gpt-4o-mini | Measure run alignment to goal |
| `default` | gpt-5.2 | General purpose |

### 8.3 Cost Tracking

```python
# Every LLM call logged to llm_calls table
class LLMCall:
    id: UUID
    profile: str
    model: str
    input_tokens: int
    output_tokens: int
    latency_ms: int
    cost_usd: Decimal  # Calculated from token counts
    run_id: Optional[UUID]  # For attribution
    tenant_id: UUID
```

### 8.4 Temporal Isolation in LLM Calls

```python
# LeakageGuard prevents LLM from accessing future data
class LeakageGuard:
    def __init__(self, cutoff_time: datetime):
        self.cutoff_time = cutoff_time

    def check_access(self, data_time: datetime, source: str):
        if data_time > self.cutoff_time:
            raise LeakageViolationError(
                f"Attempted to access {source} data from {data_time}, "
                f"but cutoff is {self.cutoff_time}"
            )
```

---

## 9. UI Pages & Components

### 9.1 Page Inventory (88 pages)

**Authentication (3 pages):**
- `/auth/login` - Login form
- `/auth/register` - Registration form
- `/auth/forgot-password` - Password reset

**Dashboard (30+ pages):**
- `/dashboard` - Main overview
- `/dashboard/projects` - Project list
- `/dashboard/projects/new` - Create project
- `/dashboard/projects/[id]` - Project detail
- `/dashboard/projects/[id]/scenarios/new` - Create scenario
- `/dashboard/projects/[id]/target-mode` - Target mode config
- `/dashboard/projects/[id]/society-mode` - Society mode config
- `/dashboard/runs` - Run list
- `/dashboard/runs/[id]` - Run detail
- `/dashboard/runs/[id]/telemetry` - Run telemetry viewer
- `/dashboard/runs/[id]/audit` - Run audit report
- `/dashboard/personas` - Persona list
- `/dashboard/personas/new` - Create persona
- `/dashboard/personas/[id]` - Persona detail
- `/dashboard/calibration` - Calibration dashboard
- `/dashboard/marketplace` - Template marketplace
- ...and more

**Project-Specific Routes (`/p/[projectId]/`):**
- `/p/[projectId]/overview` - Project overview
- `/p/[projectId]/event-lab` - Event Lab (what-if)
- `/p/[projectId]/run-center` - Run orchestration
- `/p/[projectId]/universe-map` - Node graph visualization
- `/p/[projectId]/data-personas` - Persona management
- `/p/[projectId]/rules` - Rule configuration
- `/p/[projectId]/reliability` - Reliability metrics
- `/p/[projectId]/reports` - Report generation
- `/p/[projectId]/replay` - 2D replay viewer
- `/p/[projectId]/world` - World viewer
- `/p/[projectId]/settings` - Project settings

### 9.2 Key Components

| Component | Location | Purpose |
|-----------|----------|---------|
| `PILWizard` | `components/pil/` | Blueprint configuration wizard |
| `UniverseMap` | `components/` | Node graph visualization (React Flow) |
| `RunProgressCard` | `components/simulation/` | Real-time run progress |
| `TelemetryViewer` | `components/` | Telemetry data explorer |
| `EventLabEditor` | `components/` | What-if scenario builder |
| `PersonaCard` | `components/` | Persona display card |

### 9.3 State Management

**React Query (Server State):**
```typescript
// apps/web/src/hooks/useApi.ts
export function useProjects() {
  return useQuery({
    queryKey: ['projects'],
    queryFn: () => api.getProjects(),
  });
}

export function useCreateRun() {
  return useMutation({
    mutationFn: (data: CreateRunRequest) => api.createRun(data),
    onSuccess: () => queryClient.invalidateQueries(['runs']),
  });
}
```

**Zustand (UI State):**
```typescript
// Local UI state (selected items, modal state, etc.)
const useUIStore = create((set) => ({
  selectedNodeId: null,
  setSelectedNodeId: (id) => set({ selectedNodeId: id }),
}));
```

---

## 10. Testing & QA

### 10.1 Test Infrastructure

**Backend:**
- Framework: pytest + pytest-asyncio
- Coverage: Unit tests for services, integration tests for endpoints
- Command: `pytest` from `apps/api/`

**Frontend:**
- Framework: Vitest + React Testing Library
- Command: `npm run test` from `apps/web/`

### 10.2 Test Account

```json
{
  "email": "claude-test@agentverse.io",
  "password": "TestAgent2024!"
}
```

### 10.3 Staging QA Checklist

- [ ] Authentication flow (login, logout, session persistence)
- [ ] Project CRUD operations
- [ ] Persona creation and management
- [ ] Run execution and progress tracking
- [ ] Telemetry viewer loads correctly
- [ ] Event Lab generates scenarios
- [ ] Blueprint wizard completes
- [ ] WebSocket connections stable

---

## 11. Observability & Monitoring

### 11.1 Logging

**Backend (Structured Logging):**
```python
# apps/api/app/main.py:34-45
structlog.configure(
    processors=[
        structlog.stdlib.filter_by_level,
        structlog.stdlib.add_logger_name,
        structlog.stdlib.add_log_level,
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.processors.JSONRenderer(),
    ],
)
```

### 11.2 Metrics (Prometheus)

```python
# apps/api/app/middleware/metrics.py
# Exposed at /metrics endpoint

Metrics:
- http_requests_total (counter)
- http_request_duration_seconds (histogram)
- active_websocket_connections (gauge)
- celery_tasks_total (counter)
- llm_calls_total (counter)
- llm_tokens_total (counter)
```

### 11.3 Tracing (OpenTelemetry)

```python
# apps/api/app/core/tracing.py
# Traces sent to OTLP_ENDPOINT if configured

Instrumented:
- FastAPI (auto)
- Redis (auto)
- Celery (auto)
- LLM calls (manual spans)
```

### 11.4 Error Tracking (Sentry)

```python
# Initialized in main.py if SENTRY_DSN configured
if settings.SENTRY_DSN:
    sentry_sdk.init(
        dsn=settings.SENTRY_DSN,
        environment=settings.ENVIRONMENT,
        traces_sample_rate=0.1,
    )
```

### 11.5 Audit Logging

```python
# apps/api/app/services/audit.py
# All mutations logged with:
# - tenant_id
# - user_id
# - action
# - resource_type
# - resource_id
# - before/after state
# - timestamp
```

---

## 12. Architecture Constraints

These constraints are **non-negotiable** per `docs/project.md`:

| ID | Constraint | Description | Enforcement |
|----|------------|-------------|-------------|
| C1 | Fork-not-mutate | Never modify existing Nodes. Create new Node on any change. | `Node.is_immutable = True`, validation in endpoints |
| C2 | On-demand | No continuous simulation. Execute only when triggered. | No background simulation loops |
| C3 | Replay read-only | 2D replay queries telemetry only. Never triggers simulation. | Replay endpoint is GET-only |
| C4 | Auditable | All artifacts versioned and persisted. | RunManifest, TelemetryIndex, AuditLog |
| C5 | LLMs as compilers | LLMs plan/compile once. No LLM in tick-by-tick loops. | LLM calls only in PIL jobs and Ask endpoint |
| C6 | Multi-tenant | All data scoped by tenant_id. | TenantMiddleware, all queries include tenant filter |

---

## 13. Open Questions & TODOs

### 13.1 Known Gaps

| Area | Gap | Impact |
|------|-----|--------|
| Production Deployment | Production Railway project not yet created | Staging only |
| Monitoring | Grafana dashboards not configured | Manual log review required |
| Load Testing | No load test suite | Unknown capacity limits |
| Backup Strategy | Database backup schedule not documented | DR risk |
| API Versioning | Only v1 exists, no deprecation policy | Future migration concerns |

### 13.2 Unresolved Architectural Decisions

1. **Telemetry Storage**: Currently S3 JSONL files. Consider TimescaleDB for complex queries?
2. **WebSocket Scaling**: Single-instance WebSocket. Need Redis pub/sub for multi-instance?
3. **LLM Model Updates**: How to handle model deprecation by OpenRouter?
4. **Census Data Refresh**: Currently static. Automate annual refresh?

### 13.3 Technical Debt

- [ ] `api.ts` is 2000+ lines - consider splitting by domain
- [ ] Some migrations have `nullable=True` workarounds
- [ ] Test coverage below target for some services
- [ ] Frontend has some `any` types remaining

---

## Appendix A: Quick Reference

### A.1 Common Commands

```bash
# Local Development
docker-compose up -d                    # Start infrastructure
cd apps/api && uvicorn app.main:app --reload  # Start API
cd apps/web && npm run dev              # Start frontend

# Database
cd apps/api && alembic upgrade head     # Run migrations
cd apps/api && alembic revision --autogenerate -m "description"  # Create migration

# Testing
cd apps/api && pytest                   # Backend tests
cd apps/web && npm run test             # Frontend tests

# Deployment
git push origin main                    # Triggers Railway auto-deploy
```

### A.2 Key URLs

| Environment | Frontend | Backend |
|-------------|----------|---------|
| Local | http://localhost:3002 | http://localhost:8000 |
| Staging | https://agentverse-web-staging-production.up.railway.app | https://agentverse-api-staging-production.up.railway.app |

### A.3 API Documentation

| Environment | Swagger | ReDoc |
|-------------|---------|-------|
| Local | http://localhost:8000/docs | http://localhost:8000/redoc |
| Staging | /docs | /redoc |
| Production | Disabled | Disabled |

---

*End of PROJECT_STATE.md*
